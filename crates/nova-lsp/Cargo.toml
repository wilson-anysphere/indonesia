[package]
name = "nova-lsp"
version.workspace = true
edition.workspace = true
rust-version.workspace = true
license.workspace = true
authors.workspace = true
repository.workspace = true
description = "Nova Java language server (LSP)."

[package.metadata.dist]
dist = true

[dependencies]
anyhow = { workspace = true }
tokio = { workspace = true, features = ["macros", "rt-multi-thread", "sync", "time"] }
async-trait = "0.1"

nova-ai = { path = "../nova-ai" }
nova-ai-codegen = { path = "../nova-ai-codegen" }
nova-apt = { path = "../nova-apt" }
nova-build = { path = "../nova-build" }
nova-config = { path = "../nova-config" }
nova-cache = { path = "../nova-cache" }
nova-core = { path = "../nova-core" }
nova-dap = { path = "../nova-dap" }
nova-decompile = { path = "../nova-decompile" }
# Keep the extension system metadata/loading surface available by default, but
# make the Wasmtime-based runtime opt-in via the `wasm-extensions` feature to
# keep `cargo test` link memory under the default `scripts/cargo_agent.sh`
# RLIMIT_AS budget.
nova-ext = { path = "../nova-ext", features = ["extension-bundles"] }
nova-ide = { path = "../nova-ide" }
nova-framework-web = { path = "../nova-framework-web" }
nova-db = { path = "../nova-db" }
nova-index = { path = "../nova-index" }
nova-jdk = { path = "../nova-jdk" }
nova-memory = { path = "../nova-memory" }
nova-metrics = { path = "../nova-metrics" }
nova-project = { path = "../nova-project" }
nova-refactor = { path = "../nova-refactor" }
nova-scheduler = { path = "../nova-scheduler" }
nova-format = { path = "../nova-format" }
nova-syntax = { path = "../nova-syntax" }
nova-testing = { path = "../nova-testing" }
nova-jdwp = { path = "../nova-jdwp" }
nova-remote-proto = { path = "../nova-remote-proto" }
nova-router = { path = "../nova-router" }
nova-process = { path = "../nova-process" }
nova-build-bazel = { path = "../nova-build-bazel", features = ["bsp"] }
nova-framework-micronaut = { path = "../nova-framework-micronaut" }
nova-vfs = { path = "../nova-vfs", features = ["lsp"] }

# Hardening / crash recovery support.
nova-bugreport = { path = "../nova-bugreport" }
tracing = { workspace = true }
lsp-types = "0.97"
lsp-server = "0.7"
crossbeam-channel = "0.5"
nova-workspace = { path = "../nova-workspace" }
schemars = "0.8"
serde = { version = "1.0", features = ["derive"] }
serde_json = "1.0"
thiserror = "1.0"
tokio-util = "0.7"
url = "2"
walkdir = "2"
globset = "0.4"

[features]
default = ["ai"]
ai = ["nova-ide/ai"]
# Enable third-party WASM extensions (Wasmtime runtime). Off by default to keep
# debug/test builds within the 4G RLIMIT_AS enforced by `scripts/cargo_agent.sh`.
wasm-extensions = ["nova-ext/wasm-extensions"]
# Optional Build Server Protocol integration for Bazel via `nova-build-bazel`.
bsp = ["nova-build-bazel/bsp"]

[dev-dependencies]
httpmock = "0.7"
futures = "0.3"
pretty_assertions = "1.4"
tempfile = "3.10.1"
nova-test-utils = { path = "../nova-test-utils", default-features = false, features = ["fixtures"] }
nova-types = { path = "../nova-types" }
nova-framework = { path = "../nova-framework" }
ra_salsa = { package = "ra_ap_salsa", version = "0.0.269" }
zip = { version = "0.6", default-features = false, features = ["deflate"] }

[[bin]]
name = "nova-lsp"
path = "src/main.rs"
# `nova-lsp` is exercised via integration tests spawning the built binary.
# Disabling the per-bin test harness keeps link-time memory usage under the
# default `scripts/cargo_agent.sh` RLIMIT_AS budget.
test = false

[[test]]
name = "stdio_server"
path = "tests/tests.rs"
