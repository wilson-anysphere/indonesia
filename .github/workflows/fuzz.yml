name: Fuzz

on:
  schedule:
    # Nightly fuzzing run (UTC).
    - cron: "0 3 * * *"
  workflow_dispatch:

permissions:
  contents: read

jobs:
  fuzz:
    runs-on: ubuntu-latest
    timeout-minutes: 60
    env:
      CARGO_TERM_COLOR: never
      RUST_BACKTRACE: "1"
    steps:
      - uses: actions/checkout@v4
        timeout-minutes: 5

      - uses: dtolnay/rust-toolchain@nightly
        timeout-minutes: 10
        with:
          components: llvm-tools-preview, rust-src

      - uses: Swatinem/rust-cache@v2
        timeout-minutes: 5
        with:
          cache-on-failure: true
          workspaces: |
            . -> target
            fuzz -> target
            crates/nova-remote-proto/fuzz -> target
            crates/nova-remote-rpc/fuzz -> target

      - name: Cargo.lock up-to-date
        timeout-minutes: 5
        run: |
          set -euo pipefail
          cargo metadata --locked --format-version 1 > /dev/null

      # cargo-fuzz is required for libFuzzer integration and is expensive to build from source.
      # Use cargo-binstall to fetch a prebuilt binary (pinned for reproducibility).
      - name: Install cargo-binstall
        uses: taiki-e/install-action@v2
        timeout-minutes: 5
        with:
          tool: cargo-binstall

      - name: Install cargo-fuzz
        run: cargo +nightly binstall cargo-fuzz --version 0.13.1 --no-confirm --locked --disable-strategies compile --disable-telemetry
        timeout-minutes: 5
        env:
          GITHUB_TOKEN: ${{ github.token }}

      - name: nova-remote-proto/decode_framed_message
        working-directory: crates/nova-remote-proto
        run: cargo +nightly fuzz run --codegen-units 16 decode_framed_message -- -max_total_time=30 -max_len=262144
        timeout-minutes: 20

      - name: nova-remote-proto/decode_v3_wire_frame
        working-directory: crates/nova-remote-proto
        run: cargo +nightly fuzz run --codegen-units 16 decode_v3_wire_frame -- -max_total_time=30 -max_len=262144
        timeout-minutes: 20

      - name: nova-remote-proto/decode_v3_rpc_payload
        working-directory: crates/nova-remote-proto
        run: cargo +nightly fuzz run --codegen-units 16 decode_v3_rpc_payload -- -max_total_time=30 -max_len=262144
        timeout-minutes: 20

      - name: nova-remote-rpc/v3_framed_transport
        working-directory: crates/nova-remote-rpc
        run: cargo +nightly fuzz run --codegen-units 16 v3_framed_transport -- -max_total_time=30 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_syntax_parse
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_syntax_parse -- -max_total_time=60 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_reparse_java
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_reparse_java -- -max_total_time=60 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_format
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_format -- -max_total_time=60 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_range_format
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_range_format -- -max_total_time=60 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_on_type_format
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_on_type_format -- -max_total_time=60 -max_len=262144
        timeout-minutes: 20

      - name: format_java (idempotence)
        run: cargo +nightly fuzz run --codegen-units 16 format_java -- -max_total_time=30 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_classfile
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_classfile -- -max_total_time=60 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_junit_report
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_junit_report -- -max_total_time=60 -max_len=262144
        timeout-minutes: 20

      - name: fuzz_completion
        run: cargo +nightly fuzz run --codegen-units 16 fuzz_completion -- -max_total_time=30 -max_len=262144
        timeout-minutes: 20

      - name: refactor_smoke (best-effort; --features refactor)
        run: cargo +nightly fuzz run --codegen-units 16 --features refactor refactor_smoke -- -max_total_time=30 -max_len=262144
        timeout-minutes: 30

      - name: Cargo.lock unchanged
        if: always()
        shell: bash
        timeout-minutes: 5
        run: |
          set -euo pipefail
          if ! git diff --exit-code -- Cargo.lock; then
            echo "Cargo.lock changed during CI; run cargo update locally and commit Cargo.lock."
            exit 1
          fi

      - name: Upload fuzz artifacts
        if: failure()
        uses: actions/upload-artifact@v4
        timeout-minutes: 5
        with:
          name: fuzz-artifacts
          path: |
            fuzz/artifacts/**
            crates/nova-remote-proto/fuzz/artifacts/**
            crates/nova-remote-rpc/fuzz/artifacts/**
          if-no-files-found: ignore
