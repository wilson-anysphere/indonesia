name: CI

on:
  push:
    branches: [main]
  pull_request:

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  lint:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          # Needed for scripts/check-test-binary-drift.sh, which inspects the PR base commit.
          fetch-depth: 0
      - name: test binary drift guard
        if: github.event_name == 'pull_request'
        env:
          GITHUB_BASE_SHA: ${{ github.event.pull_request.base.sha }}
        run: ./scripts/check-test-binary-drift.sh
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: rustfmt, clippy
      - uses: Swatinem/rust-cache@v2
      - name: Cargo.lock preflight (metadata --locked)
        # Note: don't add `--no-deps` here. `cargo metadata --locked --no-deps` can still succeed
        # even when Cargo.lock is stale (e.g. after changing workspace member dependencies).
        run: cargo metadata --locked --format-version 1 > /dev/null
      - name: fmt
        run: cargo fmt --all -- --check
      - name: repo invariants (nova-devtools)
        run: ./scripts/check-repo-invariants.sh
      - name: clippy
        run: cargo clippy --locked --all-targets --all-features -- -D warnings
      - name: Cargo.lock unchanged
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --exit-code -- Cargo.lock; then
            echo "Cargo.lock changed during CI; run cargo update locally and commit Cargo.lock."
            exit 1
          fi

  test:
    name: test (${{ matrix.os }})
    runs-on: ${{ matrix.os }}
    timeout-minutes: 45
    env:
      RUST_BACKTRACE: 1
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, macos-latest, windows-latest]
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - name: Install cargo-nextest
        uses: taiki-e/install-action@nextest
      - uses: Swatinem/rust-cache@v2
      - name: test (nextest)
        run: cargo nextest run --locked --workspace --profile ci
      - name: Cargo.lock unchanged
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --exit-code -- Cargo.lock; then
            echo "Cargo.lock changed during CI; run cargo update locally and commit Cargo.lock."
            exit 1
          fi
      - name: Upload nextest JUnit report
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: nextest-junit-${{ matrix.os }}
          if-no-files-found: ignore
          path: target/nextest/ci/junit.xml

  doctest:
    name: doctest (ubuntu)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    env:
      RUST_BACKTRACE: 1
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
      - uses: Swatinem/rust-cache@v2
      - name: doctest
        run: cargo test --locked --workspace --doc
      - name: Cargo.lock unchanged
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --exit-code -- Cargo.lock; then
            echo "Cargo.lock changed during CI; run cargo update locally and commit Cargo.lock."
            exit 1
          fi

  wasm:
    name: wasm example (ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          targets: wasm32-unknown-unknown
      - uses: Swatinem/rust-cache@v2
      - name: check (wasm32-unknown-unknown)
        run: cargo check --locked -p nova-ext-wasm-example-todos --target wasm32-unknown-unknown
      - name: Cargo.lock unchanged
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --exit-code -- Cargo.lock; then
            echo "Cargo.lock changed during CI; run cargo update locally and commit Cargo.lock."
            exit 1
          fi

  workflows:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: rhysd/actionlint@v1

  vscode:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - uses: actions/setup-node@v4
        with:
          node-version: "20"
          cache: "npm"
          cache-dependency-path: editors/vscode/package-lock.json
      - name: Check version sync
        run: |
          ./scripts/sync-versions.sh
          git diff --exit-code
      - name: Install dependencies
        working-directory: editors/vscode
        run: npm ci
      - name: Run unit tests
        working-directory: editors/vscode
        run: npm test
      - name: Package VSIX
        working-directory: editors/vscode
        run: |
          npm run package
