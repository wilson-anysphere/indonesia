name: Real project fixtures

on:
  workflow_dispatch:
    inputs:
      only:
        description: "Comma-separated fixture names to run (optional, e.g. guava,spring-petclinic)"
        required: false
        default: ""
  push:
    branches: [main]
    paths:
      - ".github/workflows/real-projects.yml"
      - "crates/nova-workspace/tests/workspace_events.rs"
      - "crates/nova-workspace/tests/suite/mod.rs"
      - "crates/nova-workspace/tests/suite/real_projects.rs"
      - "crates/nova-cli/tests/real_projects.rs"
      - "crates/nova-cli/tests/suite/mod.rs"
      - "scripts/run-real-project-tests.sh"
      - "scripts/clone-test-projects.sh"
      - "scripts/javac-validate.sh"
      - "test-projects/pins.toml"
  schedule:
    # Offset from other nightly workflows (e.g. fuzz.yml) to avoid running all heavy jobs at once.
    - cron: "0 4 * * *"

permissions:
  contents: read

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: false

jobs:
  real-projects:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    env:
      CARGO_TERM_COLOR: never
      RUST_BACKTRACE: "1"
      RUST_TEST_THREADS: "1"
      # The test suite uses `NOVA_TEST_PROJECTS` (and `NOVA_REAL_PROJECT` as an alias)
      # to skip fixtures when iterating.
      NOVA_TEST_PROJECTS: ${{ github.event.inputs.only || '' }}
      NOVA_REAL_PROJECT: ${{ github.event.inputs.only || '' }}

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Java
        uses: actions/setup-java@v4
        with:
          distribution: temurin
          java-version: "17"

      - name: Toolchain
        uses: dtolnay/rust-toolchain@stable
        with:
          toolchain: 1.92.0
          components: rustfmt, clippy

      - name: Rust cache
        uses: Swatinem/rust-cache@v2

      - name: Cargo.lock up-to-date
        run: |
          set -euo pipefail
          cargo metadata --locked --format-version 1 > /dev/null

      - name: Prepare cache directories
        run: |
          set -euxo pipefail
          # `actions/cache` path patterns are resolved before restore. Ensure the
          # fixture directories exist so the `test-projects/*/` glob matches.
          if [[ -f test-projects/pins.toml ]]; then
            awk '
            /^[[:space:]]*\[[^]]+\][[:space:]]*$/ {
              name = $0
              sub(/^[[:space:]]*\[/, "", name)
              sub(/\][[:space:]]*$/, "", name)
              print name
            }' test-projects/pins.toml | while read -r name; do
              [[ -n "$name" ]] && mkdir -p "test-projects/$name"
            done
          fi

          # Same idea for Maven caches.
          mkdir -p ~/.m2/repository ~/.m2/wrapper

      - name: Restore test projects cache
        id: test-projects-cache
        uses: actions/cache/restore@v4
        with:
          # Cache only the fixture repositories (not the pinned metadata files in the
          # `test-projects/` root) to avoid overwriting `pins.toml` on restore.
          path: test-projects/*/
          key: test-projects-v2-${{ runner.os }}-${{ hashFiles('test-projects/pins.toml') }}
          restore-keys: |
            test-projects-v2-${{ runner.os }}-

      - name: Restore Maven cache (best-effort)
        id: maven-cache
        uses: actions/cache/restore@v4
        with:
          path: |
            ~/.m2/repository
            ~/.m2/wrapper
          key: m2-${{ runner.os }}-java17-${{ hashFiles('test-projects/pins.toml') }}
          restore-keys: |
            m2-${{ runner.os }}-java17-

      - name: Run real project tests
        run: |
          set -euxo pipefail
          mkdir -p real-project-logs
          ./scripts/run-real-project-tests.sh 2>&1 | tee real-project-logs/run-real-project-tests.log

      - name: Cargo.lock unchanged
        if: always()
        shell: bash
        run: |
          set -euo pipefail
          if ! git diff --exit-code -- Cargo.lock; then
            echo "Cargo.lock changed during CI; run cargo update locally and commit Cargo.lock."
            exit 1
          fi

      - name: Record fixture revisions
        if: always()
        run: |
          set -euxo pipefail
          mkdir -p real-project-logs
          {
            echo "fixture head"
            if [[ -n "${NOVA_TEST_PROJECTS:-}" ]]; then
              only="${NOVA_TEST_PROJECTS//[[:space:]]/}"
              IFS=',' read -r -a fixtures <<<"$only"
              for repo in "${fixtures[@]}"; do
                [[ -z "$repo" ]] && continue
                repo_dir="test-projects/$repo"
                if [[ -d "$repo_dir/.git" ]]; then
                  sha="$(git -C "$repo_dir" rev-parse HEAD)"
                  echo "$repo $sha"
                fi
              done
            else
              shopt -s nullglob
              for repo_dir in test-projects/*; do
                if [[ -d "$repo_dir/.git" ]]; then
                  repo="$(basename "$repo_dir")"
                  sha="$(git -C "$repo_dir" rev-parse HEAD)"
                  echo "$repo $sha"
                fi
              done
            fi
          } | tee real-project-logs/fixture-revisions.log

      - name: javac validate (best-effort)
        if: always()
        continue-on-error: true
        run: |
          set -euxo pipefail
          mkdir -p real-project-logs
          ./scripts/javac-validate.sh 2>&1 | tee real-project-logs/javac-validate.log

      - name: Clean fixture build outputs
        if: always()
        run: |
          set -euxo pipefail
          # Keep the cache focused on the checked-out source trees, not build outputs.
          if [[ -d test-projects ]]; then
            find test-projects \
              -path '*/.git' -prune -o \
              -type d -name target -prune -exec rm -rf {} +
          fi

      - name: Check fixture cache completeness
        id: fixture-cache
        if: always()
        run: |
          set -euo pipefail
          complete=true
          if [[ -f test-projects/pins.toml ]]; then
            while read -r name; do
              [[ -z "$name" ]] && continue
              if [[ ! -f "test-projects/$name/.git/HEAD" ]]; then
                complete=false
                break
              fi
            done < <(
              awk '
              /^[[:space:]]*\[[^]]+\][[:space:]]*$/ {
                name = $0
                sub(/^[[:space:]]*\[/, "", name)
                sub(/\][[:space:]]*$/, "", name)
                print name
              }' test-projects/pins.toml
            )
          else
            complete=false
          fi
          echo "complete=$complete" >> "$GITHUB_OUTPUT"

      - name: Check Maven cache contents
        id: m2-cache
        if: always()
        run: |
          set -euo pipefail
          nonempty=false

          if [[ -d ~/.m2/repository ]]; then
            if find ~/.m2/repository -type f -print -quit 2>/dev/null | grep -q .; then
              nonempty=true
            fi
          fi

          if [[ "${nonempty}" != "true" && -d ~/.m2/wrapper ]]; then
            if find ~/.m2/wrapper -type f -print -quit 2>/dev/null | grep -q .; then
              nonempty=true
            fi
          fi

          echo "nonempty=${nonempty}" >> "$GITHUB_OUTPUT"

      - name: Save Maven cache (best-effort)
        if: always() && steps.maven-cache.outputs.cache-hit != 'true' && steps.m2-cache.outputs.nonempty == 'true' && env.NOVA_TEST_PROJECTS == ''
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: |
            ~/.m2/repository
            ~/.m2/wrapper
          key: m2-${{ runner.os }}-java17-${{ hashFiles('test-projects/pins.toml') }}

      - name: Save test projects cache
        if: always() && steps.test-projects-cache.outputs.cache-hit != 'true' && steps.fixture-cache.outputs.complete == 'true' && env.NOVA_TEST_PROJECTS == ''
        continue-on-error: true
        uses: actions/cache/save@v4
        with:
          path: test-projects/*/
          key: test-projects-v2-${{ runner.os }}-${{ hashFiles('test-projects/pins.toml') }}

      - name: Summary
        if: always()
        run: |
          set -euxo pipefail
          {
            echo "## Real project fixtures"
            echo
            echo "### pins.toml"
            echo
            echo '```toml'
            cat test-projects/pins.toml
            echo '```'
            echo
            echo "### Checked-out fixture SHAs"
            echo
            echo '```text'
            cat real-project-logs/fixture-revisions.log || true
            echo '```'
          } >> "$GITHUB_STEP_SUMMARY"

      - name: Upload logs
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: real-project-logs
          if-no-files-found: warn
          path: |
            real-project-logs/*.log
            test-projects/pins.toml
